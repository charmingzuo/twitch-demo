import * as request from 'request';
import qs = require('querystring');
import fileLog from '../../lib/log'
import messages from '../../common/messages'
import {OAUTH, BASE_URI} from '../twitch-config'
import {HTTP_PROXY} from '../../tsw/tsw-config';
import log from '../../lib/log'

let req = request;
if (HTTP_PROXY) {
    req = request.defaults({'proxy': HTTP_PROXY});
}

// req.debug = true;

abstract class AbstractAPI {

    abstract getMethod(): string;

    abstract getOAuth(): boolean;

    abstract getPathname?(): string;

    /**
     * 发请求
     * @param {*} query
     * @param {String} query.accessToken
     * @param {Function} cb
     */
    request(query: any, cb: Function) {
        let me = this;

        // let query = Object.assign({}, {
        //     client_id: OAUTH.CLIENT_ID,
        //     state: Math.random()
        // }, args);
        query.client_id = OAUTH.CLIENT_ID;
        query.state = Math.random();

        log.debug(JSON.stringify(this));

        let apiURL = BASE_URI + this.getPathname();
        let apiHeaders = {
            'Client-ID': OAUTH.CLIENT_ID
        };
        let apiPostData;

        if (me.getMethod() === 'GET') {
            apiURL += '?' + qs.stringify(query);
        }
        else if (me.getMethod() === 'POST') {
            apiPostData = query;
        }

        if (this.getOAuth()) {
            apiHeaders['Authorization'] = 'OAuth ' + query.accessToken;
        }

        log.info(`[TWITCH API]
                     url=${apiURL}
                     method=${me.getMethod()}
                     headers=${apiHeaders ? JSON.stringify(apiHeaders) : ''}`);

        //if (args.oAuthToken) {
        //    headers['Authorization'] = 'OAuth ' + args.oAuthToken;
        //}

        request({
            method: me.getMethod(),
            url: apiURL,
            proxy: HTTP_PROXY,
            headers: apiHeaders,
            form: apiPostData
        }, (err, res, body) => {
            let json;
            if (!err && res.statusCode == 200) {
                try {
                    json = JSON.parse(body);
                } catch (e) {
                    log.error(`${me.getPathname()} 解析Twitch返回值失败 ${e.message}`);
                    err = messages.ERR_PARSE_JSON_FAILED;
                }
            }

            if (json) {
                log.info('请求Twitch接口成功');
                fileLog.info(JSON.stringify(json));
                cb(null, json);
            }
            else {
                log.error(`err=${(err || '')}, statusCode=${res ? res.statusCode : ''}, body=${JSON.stringify(body)}`);
                cb(messages.ERR_REQUEST_TWITCH_API_FAILED, {});
            }
        });
    }
}

export default AbstractAPI;
