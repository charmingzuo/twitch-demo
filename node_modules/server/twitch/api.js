let request = require('request');
let qs = require('querystring');
const messages = require('../common/messages');
const twitchConfig = require('./twitch-config');
const twitchOauth = twitchConfig.OAUTH;
const httpProxy = require('../tsw/tsw-config').httpProxy;

if (httpProxy) {
    request = request.defaults({'proxy': httpProxy});
}

//require('request').debug = true;

module.exports = {

    request: (apiName, args, cb)=> {
        "use strict";

        let logger = plug('logger');

        let query = Object.assign({},    {
            client_id: twitchOauth.CLIENT_ID,
            state: Math.random()
        }, args);

        let apiURL = twitchConfig.BASE_URI + apiName + '?' + qs.stringify(query);
        logger.info(`[${apiName}] ${apiURL}`);

        request.get(apiURL, {
            proxy: httpProxy
        }, (err, res, body)=> {
            let json;
            if (!err && res.statusCode == 200) {
                try {
                    json = JSON.parse(body);
                } catch (e) {
                    logger.error(`${apiName} 解析Twitch返回值失败 ${e.message}`);
                    err = messages.ERR_PARSE_JSON_FAILED;
                }
            }

            if (json) {
                logger.info('请求Twitch接口成功');
                cb(null, json);
            }
            else {
                logger.error(`err=${(err || '')}, status=${res ? res.status : ''}, body=${JSON.stringify(body)}`);
                cb(messages.ERR_REQUEST_TWITCH_API_FAILED, {});
            }

        });

    }

};